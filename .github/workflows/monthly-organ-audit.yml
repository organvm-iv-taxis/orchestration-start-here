name: Monthly Organ Audit

on:
  schedule:
    - cron: '0 2 1 * *'  # 1st of month, 2 AM UTC
  workflow_dispatch:  # Manual trigger

jobs:
  audit:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Run Organ Audit
        run: |
          python3 scripts/organ-audit.py \
            --registry registry.json \
            --governance governance-rules.json \
            --output audit-report.md

      - name: Calculate Metrics
        run: |
          python3 scripts/calculate-metrics.py \
            --registry registry.json \
            --output metrics.json

      - name: Create GitHub Issue with Report
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('audit-report.md', 'utf8');
            const metrics = JSON.parse(fs.readFileSync('metrics.json', 'utf8'));
            const date = new Date().toISOString().split('T')[0];

            const metricsSection = [
              '',
              '## System Metrics',
              '',
              `| Metric | Value |`,
              `|--------|-------|`,
              `| Total repos | ${metrics.total_repos} |`,
              `| On GitHub | ${metrics.repos_on_github} |`,
              `| Documented | ${metrics.documented_repos} |`,
              `| Flagships | ${metrics.flagship_repos} |`,
              `| Operational organs | ${metrics.operational_organs}/${metrics.total_organs} |`,
              `| Completion | ${metrics.completion}% |`,
              `| Dependencies | ${metrics.total_dependencies} |`,
            ].join('\n');

            const organTable = Object.entries(metrics.organs || {}).map(([id, o]) =>
              `| ${id} | ${o.name} | ${o.status} | ${o.on_github} | ${o.documented} | ${o.flagships} |`
            ).join('\n');

            const organSection = [
              '',
              '## Per-Organ Breakdown',
              '',
              '| Organ | Name | Status | On GH | Documented | Flagships |',
              '|-------|------|--------|-------|------------|-----------|',
              organTable,
            ].join('\n');

            const body = `# Monthly Organ Audit — ${date}\n\n${report}\n${metricsSection}\n${organSection}\n\n---\n*Generated by monthly-organ-audit workflow*`;

            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Monthly Organ Audit — ${date}`,
              body: body,
              labels: ['audit', 'monthly']
            });

      - name: Update Audit Timestamp in Registry
        run: |
          python3 << 'PYEOF'
          import json
          from datetime import datetime

          with open('registry.json') as f:
              registry = json.load(f)
          with open('metrics.json') as f:
              metrics = json.load(f)

          registry['last_audit'] = datetime.now().isoformat()
          registry.setdefault('audit_history', []).append({
              'date': datetime.now().isoformat(),
              'status': 'completed',
              'triggered_by': 'monthly-organ-audit',
              'metrics': {
                  'total_repos': metrics['total_repos'],
                  'documented': metrics['documented_repos'],
                  'completion': metrics['completion'],
                  'operational_organs': metrics['operational_organs'],
                  'dependencies': metrics['total_dependencies'],
              }
          })

          with open('registry.json', 'w') as f:
              json.dump(registry, f, indent=2)
              f.write('\n')
          PYEOF

          git config user.name "Orchestration Bot"
          git config user.email "bot@organvm.dev"
          git add registry.json
          git diff --cached --quiet || git commit -m "Monthly audit metrics — $(date +%Y-%m-%d)"
          git push || true
