name: Registry Sync Check

# Detects drift between the canonical registry-v2.json in organvm-corpvs-testamentvm
# and any stale copies. Runs weekly Monday 05:00 UTC (before health audit at 06:00).

on:
  schedule:
    - cron: '0 5 * * 1'
  workflow_dispatch:

jobs:
  sync-check:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write

    steps:
      - name: Checkout orchestration hub
        uses: actions/checkout@v4

      - name: Check registry sync
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python3 << 'SYNC_CHECK'
          import json
          import subprocess
          import sys
          from datetime import datetime

          CANONICAL_URL = "https://raw.githubusercontent.com/meta-organvm/organvm-corpvs-testamentvm/main/registry-v2.json"

          def fetch_url(url):
              result = subprocess.run(
                  ['curl', '-sSfL', url],
                  capture_output=True, text=True
              )
              if result.returncode != 0:
                  return None
              return result.stdout

          # Fetch canonical registry
          canonical_raw = fetch_url(CANONICAL_URL)
          if not canonical_raw:
              print("::error::Cannot fetch canonical registry-v2.json from organvm-corpvs-testamentvm")
              sys.exit(1)

          canonical = json.loads(canonical_raw)

          # Check local registry.json (should be a redirect stub)
          issues = []
          try:
              with open("registry.json") as f:
                  local = json.load(f)
              if "_redirect" not in local:
                  issues.append(
                      "registry.json is NOT a redirect stub — it may contain stale data. "
                      "Expected a stub with '_redirect' key."
                  )
              else:
                  print("registry.json is correctly a redirect stub.")
          except FileNotFoundError:
              print("registry.json not found (acceptable).")
          except json.JSONDecodeError:
              issues.append("registry.json is not valid JSON.")

          # Report canonical registry stats
          total = canonical.get("summary", {}).get("total_repos", "?")
          organs = len(canonical.get("organs", {}))
          print(f"Canonical registry: {total} repos across {organs} organs")

          # Count actual repos in canonical
          actual_count = 0
          for organ in canonical.get("organs", {}).values():
              actual_count += len(organ.get("repositories", []))

          declared_total = canonical.get("summary", {}).get("total_repos", 0)
          if declared_total != actual_count:
              issues.append(
                  f"Canonical registry internal inconsistency: "
                  f"summary says {declared_total} repos but {actual_count} found in organs"
              )

          if issues:
              now = datetime.utcnow().isoformat() + "Z"
              body_lines = [
                  "## Registry Sync Check — Issues Detected",
                  f"**Timestamp:** {now}",
                  "",
              ]
              for i, issue in enumerate(issues, 1):
                  body_lines.append(f"{i}. {issue}")
                  print(f"::error::{issue}")

              body_lines.append("")
              body_lines.append("---")
              body_lines.append("*Generated by registry-sync-check.yml*")

              body = "\n".join(body_lines)
              title = f"Registry Sync Issue — {datetime.utcnow().strftime('%Y-%m-%d')}"

              subprocess.run(
                  ['gh', 'issue', 'create', '--title', title, '--body', body],
                  capture_output=True, text=True
              )
              sys.exit(1)
          else:
              print("No sync issues detected.")

          SYNC_CHECK
