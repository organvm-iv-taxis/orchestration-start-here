name: Validate Dependencies

on:
  pull_request:
    paths:
      - '.meta/dependencies.json'
      - 'package.json'
      - 'requirements.txt'
      - 'Cargo.toml'
  workflow_dispatch:

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Fetch Central Registry
        run: |
          curl -sL https://raw.githubusercontent.com/organvm-iv-taxis/orchestration-start-here/main/registry.json \
            -o registry.json
          curl -sL https://raw.githubusercontent.com/organvm-iv-taxis/orchestration-start-here/main/governance-rules.json \
            -o governance-rules.json

      - name: Validate Dependencies
        id: validate
        run: |
          python3 << 'PYEOF'
          import json
          import os
          import sys

          # Load registry and governance rules
          with open('registry.json') as f:
              registry = json.load(f)
          with open('governance-rules.json') as f:
              governance = json.load(f)

          current_repo = os.environ.get('GITHUB_REPOSITORY', '')
          org_name = current_repo.split('/')[0] if '/' in current_repo else ''
          repo_name = current_repo.split('/')[1] if '/' in current_repo else ''

          # Map org names to organ IDs
          org_to_organ = {
              'organvm-i-theoria': 'ORGAN-I',
              'organvm-ii-poiesis': 'ORGAN-II',
              'organvm-iii-ergon': 'ORGAN-III',
              'organvm-iv-taxis': 'ORGAN-IV',
              'organvm-v-logos': 'ORGAN-V',
              'organvm-vi-koinonia': 'ORGAN-VI',
              'organvm-vii-kerygma': 'ORGAN-VII',
          }

          current_organ = org_to_organ.get(org_name, 'UNKNOWN')
          allowed = governance.get('articles', {}).get('II', {}).get('allowed_dependencies', {})
          MAX_TRANSITIVE_DEPTH = 4

          violations = []
          results = []

          # Build full dependency graph for cycle + depth checking
          dep_graph = {}
          for organ_id, organ in registry.get('organs', {}).items():
              for repo in organ.get('repositories', []):
                  full_name = f"{repo.get('org', '')}/{repo['name']}"
                  deps = repo.get('dependencies', [])
                  dep_graph[full_name] = deps

          # --- Check 1: Direction violations for current repo ---
          for organ_id, organ in registry.get('organs', {}).items():
              for repo in organ.get('repositories', []):
                  if repo['name'] == repo_name and repo.get('org') == org_name:
                      deps = repo.get('dependencies', [])
                      for dep in deps:
                          dep_org = dep.split('/')[0] if '/' in dep else ''
                          dep_organ = org_to_organ.get(dep_org, 'UNKNOWN')
                          if dep_organ != current_organ:
                              allowed_targets = allowed.get(current_organ, [])
                              if dep_organ not in allowed_targets:
                                  violations.append(
                                      f"Direction: {current_organ} cannot depend on "
                                      f"{dep_organ} ({current_repo} -> {dep})"
                                  )

          # --- Check 2: Circular dependency detection (DFS) ---
          visited = set()
          path = set()
          cycles = []

          def find_cycles(node, current_path):
              if node in path:
                  idx = current_path.index(node)
                  cycles.append(current_path[idx:] + [node])
                  return
              if node in visited:
                  return
              visited.add(node)
              path.add(node)
              current_path.append(node)
              for neighbor in dep_graph.get(node, []):
                  find_cycles(neighbor, current_path)
              path.remove(node)
              current_path.pop()

          for node in dep_graph:
              if node not in visited:
                  find_cycles(node, [])

          for cycle in cycles:
              violations.append(f"Circular: {' -> '.join(cycle)}")

          # --- Check 3: Transitive depth ---
          def measure_depth(node, seen=None):
              if seen is None:
                  seen = set()
              if node in seen:
                  return 0  # cycle — handled above
              seen.add(node)
              deps = dep_graph.get(node, [])
              if not deps:
                  return 0
              return 1 + max(measure_depth(d, seen.copy()) for d in deps)

          repo_full = f"{org_name}/{repo_name}"
          depth = measure_depth(repo_full)
          if depth > MAX_TRANSITIVE_DEPTH:
              violations.append(
                  f"Depth: {repo_full} has transitive depth {depth} "
                  f"(max allowed: {MAX_TRANSITIVE_DEPTH})"
              )

          # --- Report ---
          print(f"Dependency Validation for {current_repo}")
          print(f"{'=' * 50}")
          print(f"  Organ: {current_organ}")
          print(f"  Transitive depth: {depth}/{MAX_TRANSITIVE_DEPTH}")
          print()

          if violations:
              print("FAILED — violations found:")
              for v in violations:
                  print(f"  - {v}")
              # Write results for comment step
              with open('validation-results.txt', 'w') as f:
                  f.write(f"**Repo:** `{current_repo}` ({current_organ})\n")
                  f.write(f"**Transitive depth:** {depth}/{MAX_TRANSITIVE_DEPTH}\n\n")
                  f.write("**Violations:**\n")
                  for v in violations:
                      f.write(f"- {v}\n")
              sys.exit(1)
          else:
              print("PASSED — no violations detected.")
              with open('validation-results.txt', 'w') as f:
                  f.write(f"**Repo:** `{current_repo}` ({current_organ})\n")
                  f.write(f"**Transitive depth:** {depth}/{MAX_TRANSITIVE_DEPTH}\n\n")
                  f.write("No dependency violations detected.\n")
              sys.exit(0)
          PYEOF

      - name: Comment Results
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let results = 'Validation completed. See workflow run for details.';
            try {
              results = fs.readFileSync('validation-results.txt', 'utf8');
            } catch (e) {}
            const status = '${{ steps.validate.outcome }}' === 'success' ? 'PASSED' : 'FAILED';
            const emoji = status === 'PASSED' ? '✅' : '❌';
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ${emoji} Dependency Validation: ${status}\n\n${results}\n\n---\n*[Workflow run](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})*`
            });
