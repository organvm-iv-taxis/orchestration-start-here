name: Monthly Organ Audit

on:
  schedule:
    - cron: '0 2 1 * *'  # 1st of month, 2 AM UTC
  workflow_dispatch:  # Manual trigger

jobs:
  audit:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Run Organ Audit
        run: |
          python3 scripts/organ-audit.py \
            --registry registry.json \
            --governance governance-rules.json \
            --output audit-report.md

      - name: Create GitHub Issue with Report
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('audit-report.md', 'utf8');
            const date = new Date().toISOString().split('T')[0];

            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Monthly Organ Audit — ${date}`,
              body: `# Monthly Organ Audit — ${date}\n\n${report}\n\n---\n*Generated by monthly-organ-audit workflow*`,
              labels: ['audit', 'monthly']
            });

      - name: Update Audit Timestamp in Registry
        run: |
          python3 << 'PYEOF'
          import json
          from datetime import datetime

          with open('registry.json') as f:
              registry = json.load(f)

          registry['last_audit'] = datetime.now().isoformat()
          registry.setdefault('audit_history', []).append({
              'date': datetime.now().isoformat(),
              'status': 'completed',
              'triggered_by': 'monthly-organ-audit'
          })

          with open('registry.json', 'w') as f:
              json.dump(registry, f, indent=2)
              f.write('\n')
          PYEOF

          git config user.name "Orchestration Bot"
          git config user.email "bot@organvm.dev"
          git add registry.json
          git diff --cached --quiet || git commit -m "Monthly audit — $(date +%Y-%m-%d)"
          git push || true
