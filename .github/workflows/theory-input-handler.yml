name: Theory Input Handler

# Receives marketing.quarterly-signals from ORGAN-VII and creates
# a theory-input issue in ORGAN-I, completing the feedback loop
# (Edge 6: VII -> IV -> I).

on:
  repository_dispatch:
    types:
      - marketing.quarterly-signals

jobs:
  create-theory-input:
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - name: Extract payload
        id: payload
        env:
          EVENT_PAYLOAD: ${{ toJSON(github.event.client_payload) }}
        run: |
          QUARTER=$(echo "$EVENT_PAYLOAD" | jq -r '.quarter // "unknown"')
          SOURCE_REPO=$(echo "$EVENT_PAYLOAD" | jq -r '.source_repo // "organvm-vii-kerygma/.github"')
          ISSUE_NUM=$(echo "$EVENT_PAYLOAD" | jq -r '.issue_number // ""')
          EXCERPT=$(echo "$EVENT_PAYLOAD" | jq -r '.synthesis_excerpt // "No synthesis provided."')

          echo "quarter=${QUARTER}" >> "$GITHUB_OUTPUT"
          echo "source_repo=${SOURCE_REPO}" >> "$GITHUB_OUTPUT"
          echo "issue_num=${ISSUE_NUM}" >> "$GITHUB_OUTPUT"

          # Save excerpt to file (can be multi-line)
          echo "$EXCERPT" > synthesis_excerpt.txt

      - name: Check for existing issue
        id: check
        env:
          GH_TOKEN: ${{ secrets.CROSS_ORG_TOKEN || secrets.GITHUB_TOKEN }}
          QUARTER: ${{ steps.payload.outputs.quarter }}
        run: |
          EXISTING=$(gh issue list \
            --repo organvm-i-theoria/recursive-engine--generative-entity \
            --search "Theory Input: ${QUARTER} in:title" \
            --state open --json title --limit 3 2>/dev/null || echo "[]")
          COUNT=$(echo "$EXISTING" | python3 -c "
          import sys, json
          data = json.load(sys.stdin)
          print(len([i for i in data if 'Theory Input' in i.get('title','')]))
          " 2>/dev/null || echo "0")
          echo "exists=$( [ "$COUNT" -gt 0 ] && echo true || echo false )" >> "$GITHUB_OUTPUT"

      - name: Create theory-input issue in ORGAN-I
        if: steps.check.outputs.exists == 'false'
        env:
          GH_TOKEN: ${{ secrets.CROSS_ORG_TOKEN || secrets.GITHUB_TOKEN }}
          QUARTER: ${{ steps.payload.outputs.quarter }}
          SOURCE_REPO: ${{ steps.payload.outputs.source_repo }}
          ISSUE_NUM: ${{ steps.payload.outputs.issue_num }}
        run: |
          EXCERPT=$(cat synthesis_excerpt.txt)
          SOURCE_URL="https://github.com/${SOURCE_REPO}/issues/${ISSUE_NUM}"

          cat > theory_input_body.md << ISSUE_BODY
          ## Theory Input from Quarterly Feedback -- ${QUARTER}

          **Source:** ORGAN-VII (Kerygma) quarterly feedback synthesis
          **Feedback issue:** [${SOURCE_REPO}#${ISSUE_NUM}](${SOURCE_URL})
          **Edge:** VII -> IV -> I (marketing.quarterly-signals)

          ### Synthesis Excerpt

          ${EXCERPT}

          ### Action Items

          Review the synthesis above and consider:

          1. **New research directions** suggested by audience engagement patterns
          2. **Underexplored areas** where distribution data shows demand
          3. **Theory gaps** that downstream organs (II-VII) have surfaced
          4. **Cross-pollination opportunities** between organs

          This issue should be triaged by assigning one of:
          - \`priority:high\` -- immediate research needed
          - \`priority:medium\` -- add to backlog
          - \`priority:low\` -- informational only

          ---
          *Generated by theory-input-handler.yml (Edge 6: VII->IV->I)*
          ISSUE_BODY

          gh issue create \
            --repo organvm-i-theoria/recursive-engine--generative-entity \
            --title "Theory Input: ${QUARTER}" \
            --body-file theory_input_body.md \
            --label "theory-input" \
            --label "from-kerygma" \
            || echo "Issue creation failed -- may need CROSS_ORG_TOKEN for cross-org access"

      - name: Log to orchestration
        if: always()
        env:
          QUARTER: ${{ steps.payload.outputs.quarter }}
          JOB_STATUS: ${{ job.status }}
        run: |
          echo "Theory input handler completed"
          echo "Quarter: ${QUARTER}"
          echo "Status: ${JOB_STATUS}"
